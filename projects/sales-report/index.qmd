---
title: "Mock Retail Sales Report"
date: "1/21/2023"
description: "Example report made with Quarto in HTML format"
categories: ["Report Generation", "Reproducible"]
image: "images/markus-spiske-XrIfY_4cK1w-unsplash.jpg"
format:
  html:
    code-fold: true
    highlight-style: dracula
---

```{r}
#| include: false

library(tidyverse)

sales <- readxl::read_excel("retail-data.xlsx", sheet = "sales")
stores <- readxl::read_excel("retail-data.xlsx", sheet = "stores")

sales_joined <- sales |>
  left_join(stores, by = c("store_no" = "store_no"))

sales_joined$date <- lubridate::as_date(sales_joined$date)

sales_joined <- sales_joined |>
  mutate(year = lubridate::year(date)) |>
  filter(year == 2017) |>
  select(-c(year))

sales_joined$sales <- round(sales_joined$sales, 2)

sales_joined$region <- as.character(sales_joined$region)
```

## Revenue by Region

@fig-revenue_a shows that there are **opportunities** available:

For example type **C** is performing comparatively lower in terms of revenue across the brand.

Region 3 leads in revenue for type **A** stores and demand in this region for store type **B** is expected to grow over the next year.

```{r}
#| label: fig-revenue_a
#| fig-cap: Revenue in millions ($)
#| warning: false


sales_df <- sales_joined |>
  group_by(region, storetype) |>
  summarise(revenue = sum(sales),
            n_sales = n()) |>
  arrange(desc(revenue))

color_pal_1 <-c("#006b9c","#de61a8","#ffa600")

sales_df |>
  ggplot(aes(x = region, y = revenue / 1000000, fill = storetype)) +
  geom_col(position = "dodge") +
  scale_fill_manual(values = color_pal_1) +
  labs(title = "2017 Regional Revenue",
       x = "Region",
       y = "Revenue",
       fill = "Store Type") +
  scale_y_continuous(labels=scales::dollar_format(suffix = "M")) +
  theme_minimal() +
  theme(plot.title = element_text( face ="bold", hjust = 0.5),
        legend.position = "right",
        legend.title.align = 0.5,
        legend.text.align = 0.5,
        legend.box.background = element_rect(fill = "white", colour = "white"),
        plot.margin = unit(c(10,10,10,10), "pt"))
```

------------------------------------------------------------------------

## Revenue Time Series

In @fig-revenue_b we can see the trends in each region, and how each store type is performing.

```{r}
#| label: fig-revenue_b
#| fig-cap: Revenue rounded to the thousands ($)
#| warning: false

sales_joined |>
  filter(date > "2017-01-06") |>
  group_by(region, storetype, date) |>
  summarise(revenue = sum(sales)) |>
  ggplot(aes(x = date, y = revenue / 1000000, colour = storetype)) +
  geom_line() +
  scale_y_continuous(labels = scales::dollar_format(suffix = "M")) +
  scale_colour_manual(values = color_pal_1) +
  facet_wrap(~region, nrow = 3) +
  labs(title = "Revenue by Region and Store Type",
       x = "",
       y = "Revenue",
       colour = "Store Type") +
  theme_minimal() +
  theme(plot.title = element_text(face = "bold", hjust = 0.5),
        plot.margin = unit(c(10,10,10,10), "pt"))

```

------------------------------------------------------------------------

## Revenue by Department

@fig-revenue_c shows us an example of a table, and this table breaks down the revenue by department. Toys generating the most revenue, and the garden department generating the least.

```{r}
#| label: fig-revenue_c
#| fig-cap: Revenue in millions ($)
#| warning: false

department_df <- sales_joined |>
  group_by(department) |>
  summarise(revenue = sum(sales)) |>
  arrange(desc(revenue))

department_df <- department_df |>
  mutate(Department = department, ) |>
  select(Department, revenue)

department_df |>
  mutate(Revenue = scales::dollar(round(revenue, -3))) |>
  select(-c(revenue)) |>
  gt::gt() |>
  gt::tab_header(title = "Department Revenue")
```

@fig-revenue_d shows a visual version of the above department revenue table, highlighted is the **toys** department.

```{r}
#| label: fig-revenue_d
#| fig-cap: Revenue in millions ($)
#| warning: false

color_pal_2 <-c("#003f5c", "#ffa600")

department_df |>
  mutate(is_toy = ifelse(Department == "Toys", "y", "n")) |>
  ggplot(aes(x = fct_reorder(Department, -revenue), y = revenue / 1000000, fill = is_toy)) +
  geom_col() +
  scale_fill_manual(values = color_pal_2) +
  scale_y_continuous(labels=scales::dollar_format(suffix = "M")) +
  labs(title = "2017 Revenue by Department",
       x = "",
       y = "Revenue") +
  theme_minimal() +
  theme(legend.position = "none",
        axis.text.x = element_text(angle = 90, vjust = .4, hjust = 1),
        plot.margin = unit(c(10,10,10,10), "pt"),
        plot.title = element_text(face = "bold", hjust = 0.5))
```

------------------------------------------------------------------------

## Does Square Footage equal Revenue?

@fig-revenue_e shows that there is a strong positive correlation between square footage and revenue. This does not mean that having a bigger store will yield higher revenue, but it is a notable trend.

```{r}
#| label: fig-revenue_e
#| fig-cap: Revenue in millions ($)
#| warning: false

sqft_model <- sales_joined |>
  group_by(store_no) |>
  summarise(sqft = min(sqft), revenue = sum(sales))

cor.test(sqft_model$sqft, sqft_model$revenue)

sqft_model |>
  ggplot(aes(x = sqft, y = revenue / 1000000)) +
  geom_jitter() +
  geom_smooth(aes(colour = "#ff6361"), method = "lm") +
  scale_y_continuous(labels=scales::dollar_format(suffix = "M")) +
  labs(title = "Store Square Footage and Revenue",
       x = "Square Footage",
       y = "Revenue") +
  geom_label(aes(x = 50000, y = 14, label = "R = 0.771", colour = "#ff6361")) +
  theme_minimal() +
  theme(plot.title = element_text(face = "bold", hjust = 0.5),
        legend.position = "none",
        plot.margin = unit(c(10,10,10,10), "pt"))

```
